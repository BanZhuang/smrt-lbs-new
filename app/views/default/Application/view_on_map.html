#{set 'moreScripts'}
<script src="/public/js/esri.ux.layers.ClusterLayer-debug-event.js" type="text/javascript"></script>
<script src="/public/js/array.xd.js" type="text/javascript"></script>
#{/set}
#{extends theme+'/main_head.html' /}
<div id="view-on-map-splitter" style="width:99%; height:99%;">
	<div id="event-list"></div>
	<div id="map-view" region="center" style="position:relative;">
	</div>
	
</div>
<div id="event-type-list" class="configuration k-widget k-header">
    <span class="configHead">EventType filter</span>
    <ul class="options" id="event-type-list-ul">
    </ul>
</div>
#{include './map_legend.html' /}

<script>

var map = "";
var map_id = "map-view";
var getCurrentDataUrl = #{jsAction @Events.gps(':vehicleNo')/};

</script>
<script src="${static_dir}/js/vmsMap.js" type="text/javascript" charset="utf-8"></script>

<script>
(function($){
	$.getUrlParam = function(name){
	var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	var r = window.location.search.substr(1).match(reg);
	if (r!=null) return unescape(r[2]);
	 return null;
	}
})(jQuery);

function eventTypeListInit(){
	//[{"techName":"event-alarm","name":"Alarm","id":1}]
	var datas = #{verbatim} ${eventTypes} #{/verbatim};
	//alert(JSON.stringify(datas));
	 $.each(datas, function(index, data){
	 	var li = '<li style="float:left;"><input id="'+ data.techName +'" type="checkbox" checked="checked" /> <label>' + data.name + '</label></li>';
             $("#event-type-list-ul").append(li);
        });
	$("#event-type-list-ul li input").click(function(){
		if($(this).attr("checked") == "checked"){
			showEventTypeIcon($(this).attr("id"));
		}else{
			hideEventTypeIcon($(this).attr("id"));
		}
		
	});
}

var view_on_map_splitter;
var _vehicleNo = $.getUrlParam('vehicleNo');
refreshIntervalCount = 1000000*1000;//no refresh

$(document).ready(function(){
	
	eventTypeListInit();

	$("#event-list").kendoGrid({

		groupable: true,
        scrollable: true,
        sortable: true,
        pageable: true,
        selectable: true,
        height: 233,
        columns:#{verbatim} ${eventColumns} #{/verbatim},
        dataSource: {
        	 pageSize: 10,
            data: #{verbatim} ${eventData} #{/verbatim}
        }
    });
    
    $("#event-list").delegate("td", "click", function(e) {
        e.preventDefault();
        var id = _vehicleNo+ "_" +$(this).parent().find("td:last").text();
        showCurrentInfoWindow(id);
       }
     );
    
	view_on_map_splitter = $("#view-on-map-splitter").kendoSplitter({
		orientation: "vertical",
		panes: [
            { collapsible: false, size: "233px", min: "233px", width: "100%" },//up
            { collapsible: false, resizable: true, min: "300px", width: "100%"}//bottom down
        ],
        resize:function(e){
            //第一次加载时不需要resize
            if (map && map != ""){
                map.resize();
      		    map.reposition();
      	    }
        }
	}).data("kendoSplitter");
	
	bindMapinitData("addMarker('" + getCurrentDataUrl({vehicleNo: $.getUrlParam('vehicleNo')}) + "')");

});
</script>