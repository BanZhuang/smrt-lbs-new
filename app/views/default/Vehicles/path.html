#{set 'moreScripts'}
<script src="/public/js/esri.ux.layers.ClusterLayer-debug-event.js" type="text/javascript"></script>
#{/set}
#{extends theme+'/main_head.html' /}
<style>
	.k-content{background:#f3f3f3;}
    .info{
    	border:none;
        padding: 3px 5px 7px 5px;
        display:inline-block;
        width:120px;
        text-align:right;
    }
</style>
<div id="path-view-on-map-splitter" style="width:99%; height:99%;">
	<form action="/vehicles/searchPath" method="post" onsubmit="return pathSearchValidate(this)">
		<input id="path_schedule_id" type="hidden" name="scheduleId" value="-1" />
		<br />
		<label for="path-vehicles" class="info" style="width:80px;">Vehicle:</label>
		<input name="vehicleId" id="path-vehicles"/>
		<label id="path-schedules-label" for="path-schedules" style="width:80px;" class="info" >Schedule:</label>
		<input style="width:250px" name="scheduleId" id="path-schedules"/>
		<div style="height:5px;"></div>
		<label for="path-date" class="info" style="width:80px;">Date:</label>
		<input name="date" id="path-date" class="date" />
		<label for="path-start" class="info" style="width:80px;">Start:</label>
		<input name="startTime" id="path-start" style="width:99px;" />
		<label for="path-end" class="info" style="width:30px;">End:</label>
		<input name="endTime" id="path-end"  style="width:99px;"/>
		<input type="submit" id="path-search-button" class="k-button" value="Search"/>
	</form>
	
	<div id="path-map-view" region="center" style=" position:relative;"></div>
	
</div>

<script>

var map = "";//用于vmsMap.js中
var map_id = "path-map-view";//用于vmsMap.js中

</script>
<script src="${static_dir}/js/vmsMap.js" type="text/javascript" charset="utf-8"></script>

<script>
(function($){
	$.getUrlParam = function(name){
	var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	var r = window.location.search.substr(1).match(reg);
	if (r!=null) return unescape(r[2]);
	 return null;
	}
})(jQuery);

var view_on_map_splitter;

$(document).ready(function(){
	view_on_map_splitter = $("#path-view-on-map-splitter").kendoSplitter({
		orientation: "vertical",
		panes: [
            { collapsible: false, resizable:false, size: "80px", min: "80px"},//up
            { collapsible: false, resizable:false,},//middle 
        ],
        resize:function(e){
            //if is the first time loading, the map is not required to resize
            if (map && map != ""){
                map.resize();
      		    map.reposition();
      	    }
        }
	}).data("kendoSplitter");
	
	var vehicleCombo = #{verbatim} ${vehicles} #{/verbatim};
	var _index = 0;
	$.each( vehicleCombo, function(i, v){
		if (v.value == "${vehicleNo}"){
			_index = i;
			return ;
		}
	});
	
    var vehicleSelect = $("#path-vehicles").kendoComboBox({
        dataTextField: "text",
        dataValueField: "value", 
        dataSource: vehicleCombo,
        index: _index,
        change: function() {
            var value = this.value();
            var text = this.text();
        	$("#path-schedules-wrap").empty();
        	$("#path-schedules-wrap").html("<input name='scheduleId' id='path-schedules' style='width:300px'/>");
     		$("#path-schedules-label").html("Schedule");
		    
		    $.getJSON("/vehicles/schedules", {vehicleNo:value}, function(schedules){
		    	createScheduleComboBox(schedules);
		    });
        }
    });
    
    var scheduleCombo = #{verbatim} ${schedules} #{/verbatim};
    createScheduleComboBox(scheduleCombo);
    
    $("#path-date").kendoDatePicker({
        format:"yyyy-MM-dd"
    });

    $("#path-start, #path-end").kendoTimePicker({
        format:"HH:mm",
        interval:1
    });
});


function loadPath(url, params){
	var sch = $("#path_schedule_id");
	$.getJSON(url, params, function(points){
		map.graphics.clear();
		initRouteTask(points);
		sch.attr("value", params["scheduleId"]);
		$("#path-date").data("kendoDatePicker").value(params["date"]);
	});
}

function pathSearchValidate(form) {
    var $form = $(form);
	var scheduleId = $("#path_schedule_id").attr("value");
    if (!scheduleId || scheduleId < 1){
    	return false;
    }
    
    var startTimePicker = $("#path-start").data("kendoTimePicker");
    if (startTimePicker.value() == null) {
        startTimePicker.value("00:00");
    }
    var endTimePicker = $("#path-end").data("kendoTimePicker");
    if (endTimePicker.value() == null) {
        endTimePicker.value("00:00");
    }
    
    var params = $form.serializeArray();
    loadPath($form.attr("action"), params);
    
    return false;
}

function createScheduleComboBox(schedules){
	$("#path-schedules").kendoComboBox({
   		dataTextField: "text",
    	dataValueField: "value",
    	dataSource: schedules,
    	placeholder: "please choose schedule...",
    	change: function(){
    		var value = this.value();
			var text = this.text();
			
    		loadPath("/vehicles/routes", {scheduleId:value, date:text.split(",")[0]});
    	}
	});
}

function initRouteTask(points){
	var path = {"paths":[points],"spatialReference":{"wkid":3414}};
          	
	// 路径点轨迹
	var line = new esri.geometry.Polyline(path);

	// 路线图形样式
	var routeSymbol = new esri.symbol.SimpleLineSymbol().setColor(new dojo.Color("green")).setWidth(3);
	map.graphics.add(new esri.Graphic(line, routeSymbol));
	
	// 首节点图形样式
	var startNodeSymbol;
	//startNodeSymbol = new esri.symbol.SimpleMarkerSymbol().setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE).setSize(10);
    //startNodeSymbol.outline.setWidth(2);
    //startNodeSymbol.outline.setColor(new dojo.Color("red"));
    startNodeSymbol = new esri.symbol.PictureMarkerSymbol('/public/images/start-icon.png', 24, 34);
    // 尾节点图形样式
    var endNodeSymbol;
    //endNodeSymbol = new esri.symbol.SimpleMarkerSymbol().setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_X).setSize(10);
    //endNodeSymbol.outline.setWidth(2);
    //endNodeSymbol.outline.setColor(new dojo.Color("red"));
    endNodeSymbol = new esri.symbol.PictureMarkerSymbol('/public/images/end-icon.png', 24, 34);
    // var endNodeSymbol = new esri.symbol.TextSymbol("End").setAlign(esri.symbol.TextSymbol.ALIGN_END).setColor(new dojo.Color("red"));
    
    // 坐标系
	var spatial = new esri.SpatialReference({ wkid:4326 })
    // 首节点
    var startNodePoint = new esri.geometry.Point(points[0], spatial); 
    var startNode = new esri.Graphic(startNodePoint, startNodeSymbol);
    map.graphics.add(startNode);
    
    // 尾节点
    var endNodePoint = new esri.geometry.Point(points[points.length-1], spatial); 
    var endNode = new esri.Graphic(endNodePoint, endNodeSymbol);
    map.graphics.add(endNode);
}
</script>