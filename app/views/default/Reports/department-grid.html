<script src="/public/js/kendo.chart.min.js" language="javascript"></script>

<div id="dept_view-on-map-wrap">
	<div id="dept_view-on-map-window"></div>
</div>
<style>

	.k-content{
		background:#f3f3f3;
	}
	
    .k-autocomplete{
    }
    
    .info{
    	border:none;
        padding: 3px 5px 7px 5px;
        display:inline-block;
        width:120px;
        text-align:right;
    }
</style>
<form action="/reports/departmentListJson" method="post" class="k-content search-wrap" onsubmit="return reportDepartmentSearchValidate(this)" style="padding:20px 0 10px 10px;">
	
	<label for="dept_departments" class="info" style="width:80px;">Superior:</label>
	<input name="parentId" id="dept_departments"/>
	
	<label for="dept_types" class="info" >Type:</label>
	<input name="dateType" id="dept_types"/>
	
	<label id="dept_time-label" for="dept_time" class="info">Year:</label>
	<div style="display:inline;" id="dept_time-wrap">
		<input name="time" id="dept_time"/>
	</div>
	<div style="float:right; padding-right:20px;">
		<input type="submit" id="dept_search-button" class="k-button" value="Search" />
	</div>
	
</form>

<div id="dept_report_dept_grid"></div>

<div id="dept_report_dept_bar_chart"></div>

<script>

var departId;

$(document).ready(function(){
	
	loadReportDepartments("/reports/departmentListJson");
    
    $("#dept_report_dept_grid").delegate(".view-on-map-button", "click", function(e) {
        e.preventDefault();
        departId = $(this).parent().parent().find("td:last").html();
        var w_title = "View Department("+departId+") Events On Map "
        var wnd = $("#dept_view-on-map-window")
    	.kendoWindow({
    		actions: ["Custom", "Minimize", "Maximize", "Close"],
    		content: "http://"+ window.location.host + "/Maps/departmentEvents?departmentId="+departId,
    		iframe: true,
            modal: true,
            visible: false,
            resizable: true,
            width: 800,
            height: 500,
            resize:function(e){
            	$("#view-on-map-splitter").data("kendoSplitter").size("#map-view", "100%");
            }
         }).data("kendoWindow");
        
        wnd.title(w_title).center().open();
        
    });
    
    $("#dept_report_dept_grid").delegate(".view-driver-button", "click", function(e) {
        e.preventDefault();
        departId = $(this).parent().parent().find("td:last").html();
        var url = $("#report-dept-driver").attr("url");
        var newUrl ;
       	if ((index = url.indexOf("&departmentId=")) > 0){
       		newUrl = url.substring(0, "&departmentId=".length + index) + departId;
       	}else{
        	newUrl = url + "&departmentId="+departId;
        }
        
        $("#report-dept-driver").attr("url", newUrl);
        $("#report-dept-driver").find("span").click();
    });
//     
	var deptCombo = #{verbatim} ${departments} #{/verbatim};
	deptCombo[deptCombo.length] = {text: "top department", value: "0"};
    $("#dept_departments").kendoComboBox({
        dataTextField: "text",
        dataValueField: "value",
        dataSource: deptCombo
    });
//     
    $("#dept_types").kendoComboBox({
        dataTextField: "text",
        dataValueField: "value",
        dataSource: [
        	{text: "Dayly", value: "day"},
        	{text: "Weekly", value: "week"},
        	{text: "Monthly", value: "month"},
        	{text: "Yearly", value: "year"}
        ],
        change: function() {
            var value = this.value();
            var text = this.text();
        	$("#dept_time-wrap").empty();
        	$("#dept_time-wrap").html("<input name='time' id='dept_time'/>");
     		$("#dept_time-label").html(text);
        	var _format = "yyyy/MM/dd";
        	if ("month" == value){
		    	_format = "yyyy/MM";
		    	value = "year";
		    }else if ("year" == value){
		    	_format = "yyyy";
		    	value = "decade";
		    }
		    
        	$("#dept_time").kendoDatePicker({
		    	start: value,
		    	depth: value,
		    	format: _format
		    });
		    
		    $("#dept_time-wrap").show();
		    $("#dept_time-label").show();
        }
    });	
    
    $("#dept_time-wrap").hide();
    $("#dept_time-label").hide();

});

function loadReportDepartments(url, params){
	$.getJSON(url, params, function(json){
		$("#dept_report_dept_grid").empty();
		json.columns[json.columns.length] = { 
			title: "Actions",
			width: "200px", 
			command: [
				{ text: "Drivers", className: "view-driver-button" }, 
				{ text: "Map", className: "view-on-map-button" }
			]
		};
		
		json.columns[json.columns.length] = { title: "id", width: "1px", field: "id" };
		var grid = $("#dept_report_dept_grid").kendoGrid({
	    	dataSource: {
	    		data: json.data,
	    		pageSize:5
	    	},
	    	columns: json.columns, 
	   	 	scrollable: true,
	   	 	sortable: true,
	   	 	pageable: true,
	   	 	height: "auto",
	   	 	selectable: true
	   	 	
        }).data("kendoGrid");
	    
	    $("#dept_report_dept_bar_chart").empty();
	    $("#dept_report_dept_bar_chart").kendoChart({
	        theme: "default",
	        title: {
	            text: "Department Performance Comparison"
	        },
	        legend: {
	            position: "bottom"
	        },
	        seriesDefaults: {
	            type: "column",
	            stack: true
	        },
	        series: json.series,
	        categoryAxis: {
	            categories: json.categories
	        },
	        valueAxis: {
	            labels: {
	                format: "{0}"
	            }
	        },
	        
	        tooltip: {
	            visible: true,
	            template: "#= value #",
	            format: "{0}"
	        }
	    });
	});
}

function reportDepartmentSearchValidate(form) {
	var $form = $(form);
	
	loadReportDepartments($form.attr("action"), $form.serializeArray());
	
	return false;
}
</script>