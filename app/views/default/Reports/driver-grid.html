<script src="/public/js/kendo.chart.min.js" type="text/javascript"></script>
<div id="driver_result_view-on-map-wrap">
	<div id="driver_result_view-on-map-window"></div>
</div>

<form id="report_driver_search_form_${tabId}" action="/reports/driverListJson" method="post" class="k-content" onsubmit="return reportDriverSearchValidate(this)" style="padding:10px 0;">
	
	<label for="${tabId}_driverId">Driver Name:</label>
	<input name="driverId" id="${tabId}_driverId" required />
	
	<label for="${tabId}_reportType" >Time Type:</label>
	<input name="timeType" id="${tabId}_reportType" required />
	
	<label for="${tabId}_date" id="date_label">Day:</label>
	<div id="date_wrap" style="display:inline;">
		<input name="time" id="${tabId}_date" required />
	</div>
	<div style="float:right; padding-right:20px;">
		<input type="submit" id="${tabId}_search-button" class="k-button search-button" style="width:50px;" value="" />
		<input type="button" url="/excels/reportDriver" formId="report_driver_search_form_${tabId}" class="k-button export-excel-button" style="width:50px" value="" />
		<input type="button" class="k-button print-button" style="width:50px" value="" />
	</div>
</form>

<div id="grid_${tabId}"></div>

<div id="chart_bg">
	<div class="chart-wrapper">
    	<div id="pie_chart">
    	</div>
    </div>
</div>

<div id="event_grid_${tabId}"></div>

<script src="/public/js/vms.js" type="text/javascript" charset="utf-8"></script>
<script>
	var driverId = "${driverId}";
	var timeType = "${timeType}";
	var time = "${time}";
    $(document).ready(function () {
    	var driverCombo = #{verbatim} ${drivers} #{/verbatim} ;
    	var _index = 0;
		$.each( driverCombo, function(i, v){
			if (v.value == driverId){
				_index = i;
				return ;
			}
		});
		
        $("#${tabId}_driverId").kendoComboBox({
        	dataValueField: "value",
            dataTextField: "text",
            index: _index,
            dataSource: driverCombo
        });
        
        var time_type_index = 0;
    
	    var _format = "yyyy/MM/dd";
	    var depth = timeType;
	    var text = "Day";
	    if ("daily" == timeType){
			text = "Day";
		}else if ("weekly" == timeType){
			text = "Week";
			time_type_index = 1;
		}else if ("monthly" == timeType){
	    	_format = "yyyy/MM";
	    	depth = "year";
	    	text = "Month";
	    	time_type_index = 2;
	    }else if ("yearly" == timeType){
	    	_format = "yyyy";
	    	depth = "decade";
	    	text = "Year";
	    	time_type_index = 3;
	    }
	    
	    $("#date_label").html(text+":");
	    $("#${tabId}_date").kendoDatePicker({
	    	start: timeType,
	    	depth: depth,
	    	format: _format,
	    	value: time
	    });
	    
        $("#${tabId}_reportType").kendoComboBox({
        	dataValueField: "value",
            dataTextField: "value",
        	dataSource:[
                        { text: "type1", value: "daily" },
                        { text: "type2", value: "weekly" },
                        { text: "type3", value: "monthly" },
                        { text: "type4", value: "yearly" }
            ],
            index: time_type_index,
            change: function() {
                var value = this.value();
                var text = "Day";
            	$("#date_wrap").empty();
            	$("#date_wrap").html("<input name='time' id='${tabId}_date' required />");
            	var _format = "yyyy/MM/dd";
	        	if ("daily" == value){
	        		text = "Day";
	        	}else if ("weekly" == value){
					text = "Week";
				}else if ("monthly" == value){
			    	_format = "yyyy/MM";
			    	value = "year";
			    	text = "Month";
			    }else if ("yearly" == value){
			    	_format = "yyyy";
			    	value = "decade";
			    	text = "Year";
			    }
			    
    		    $("#date_label").html(text+":");
    		    
            	$("#${tabId}_date").kendoDatePicker({
    		    	start: value,
    		    	depth: value,
    		    	format: _format
    		    });
            }
        });
        
        $("#report_driver_search_form_${tabId}").kendoValidator();
        reportDriverSearchValidate($("#report_driver_search_form_${tabId}"));
    });
    
    function loadReportDrivers(url, params){
    	// keep the driver selected firstly
    	$.each(params, function(i, v){
    		if (params[i].name == "driverId" && (!params[i].value || isNaN(params[i].value) || params[i].value <= 0)){
    			alert("Please selecte a valid driver first.");
    			return false;
    		}
    	});
    	
    	//---------- driver performance report -------------
    	$.getJSON(url, params, function(json){
    		$("#grid_${tabId}").empty();
    		// json.columns[json.columns.length] = { title: "id", width: "0px", field: "id" };
            $("#grid_${tabId}").kendoGrid({
                dataSource: json.data,
                pageable: false,
    	   	 	sortable: false,
    	   	 	scrollable: false,
                columns: json.columns
            });
            
            var chartJson = json.chart;
            var eventJson = json.events;
            
            //---------- driver event-type report --------------
	    	$("#pie_chart").kendoChart({
	            theme: $(document).data("kendoSkin") || "default",
	            dataSource: json.chart,
	            title: {
	                text: "Driver Report"
	            },
	            legend: {
	                position: "bottom"
	            },
	            seriesDefaults: {
	            	type: "pie",
	            	labels: {
	                    visible: true,
	                    format: "{0}"
	                }
	            },
	            series: [{
	                field: "value",
	                categoryField: "type"
	            }],
	            tooltip: {
	                visible: true,
	                format: "{0}"
	            }
	        });
	        
	        //--------- driver event grid report ---------------
	        $("#event_grid_${tabId}").kendoGrid({
                dataSource: {
                	data: eventJson.data,
                	pageSize:8
                },
                pageable: true,
    	   	 	sortable: true,
    	   	 	scrollable: true,
                columns: eventJson.columns
            });
    	}).error(function(e){
	     	alert(e.responseText);
		});
    }
    
    function reportDriverSearchValidate(form) {
    	var $form = $(form);
    	timeType = $form.find("input[name=timeType]").val();
		time = $form.find("input[name=time]").val();
		
		var validatable = $form.kendoValidator().data("kendoValidator");
	 	if (validatable.validate()) {
	     	loadReportDrivers($form.attr("action"), $form.serializeArray());
	 	}
	    
	    return false;
	}
</script>

